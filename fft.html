<html>
    <script>
      const ctx = new AudioContext();
      const playertag = document.querySelector("audio");
      const tagSource = ctx.createMediaElementSource(
        document.querySelector("audio")
      );
      const fftr = new AnalyserNode(ctx, {
        fftSize: 256,
      });
      tagSource.connect(fftr).connect(ctx.destination);
      const fftbuff = new Uint8Array(256);

      document.querySelector("button").onclick = () => {
        playertag.play();
        updateFFT();
      };

      var canvas = document.querySelector(".visualizer");
      var canvasCtx = canvas.getContext("2d");
      const WIDTH = canvas.width;
      const HEIGHT = canvas.height;

      var intendedWidth = document.querySelector(".wrapper").clientWidth;

      canvas.setAttribute("width", intendedWidth);

      var visualSelect = document.getElementById("visual");

      var drawVisual;
      const fftoutput = document.querySelector("#fft_chart");
      function updateFFT() {
        fftr.fftSize = 256;
        var bufferLength = fftr.frequencyBinCount;
        console.log(bufferLength);
        var dataArray = new Float32Array(bufferLength);

        canvasCtx.clearRect(0, 0, WIDTH, HEIGHT);

        function draw() {
          drawVisual = requestAnimationFrame(draw);

          fftr.getFloatFrequencyData(dataArray);

          canvasCtx.fillStyle = "rgb(0, 0, 0)";
          canvasCtx.fillRect(0, 0, WIDTH, HEIGHT);

          var barWidth = (WIDTH / bufferLength) * 2.5;
          var barHeight;
          var x = 0;

          for (var i = 0; i < bufferLength; i++) {
            barHeight = (dataArray[i] + 140) * 2;

            canvasCtx.fillStyle =
              "rgb(" + Math.floor(barHeight + 100) + ",50,50)";
            canvasCtx.fillRect(
              x,
              HEIGHT - barHeight / 2,
              barWidth,
              barHeight / 2
            );

            x += barWidth + 1;
          }
        }

        draw();
      }
    </script>
  </body>
</html>
